<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å–®å­—ç·´ç¿’ï¼šæ‹¼å­—ï¼é¸æ“‡é¡Œï¼è½åŠ›ï¼éŒ¯é¡Œæœ¬ï¼ˆPart é¡Œåº«ï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --muted:#91a4c7; --text:#eaf0ff;
      --btn:#1b2a48; --btn2:#243a66; --ok:#2ecc71; --bad:#ff5c5c; --warn:#ffcc66;
      --line:#233553; --focus:#355a9b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial;
      background:linear-gradient(180deg, #0b1220, #070b14);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:min(1120px, 100%); display:grid; gap:16px}
    .header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px}
    h1{font-size:20px; margin:0}
    .sub{color:var(--muted); font-size:13px; margin-top:6px; line-height:1.55}
    .card{
      background:rgba(17,27,46,.92);
      border:1px solid rgba(35,53,83,.8);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .grid{display:grid; gap:12px}
    .two{grid-template-columns:1fr}
    @media (min-width: 920px){ .two{grid-template-columns: 1.1fr .9fr;} }

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{
      border:1px solid rgba(145,164,199,.25);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .btn:hover{background:var(--btn2)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:#2b59ff2b; border-color:#2b59ff66}
    .btn.danger{background:#ff3b3b22; border-color:#ff3b3b66}
    .btn.ok{background:#2ecc7122; border-color:#2ecc7166}
    .btn.ghost{background:transparent}

    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(145,164,199,.25);
      color:var(--muted); font-size:12px;
      background:rgba(10,19,36,.7);
    }
    .sep{height:1px; background:rgba(35,53,83,.7); margin:12px 0}
    .small{font-size:12px; color:var(--muted); line-height:1.55}
    .progress{
      height:10px; border-radius:999px; background:#0a1324; border:1px solid var(--line);
      overflow:hidden; width:min(420px, 100%);
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#2b59ff,#61d0ff)}
    .gameTop{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
    .cn{font-size:22px; line-height:1.35; margin:0; letter-spacing:.2px}
    .msg{font-size:14px; color:var(--muted); min-height:22px}
    .msg.ok{color:var(--ok)}
    .msg.bad{color:var(--bad)}
    .msg.warn{color:var(--warn)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; color:var(--muted);
      padding:2px 6px; border:1px solid rgba(145,164,199,.25);
      border-radius:8px; background:rgba(10,19,36,.7);
    }
    .toggle{display:flex; align-items:center; gap:8px; user-select:none}
    input[type="checkbox"]{transform:scale(1.1)}

    .spellBox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:12px; border-radius:16px; border:1px solid var(--line);
      background:#0a1324;
    }
    .spellInput{
      flex:1; min-width:220px; height:44px;
      border-radius:14px;
      border:1px solid rgba(145,164,199,.25);
      background:#111b2e;
      color:var(--text);
      padding:0 12px;
      font-size:18px;
      outline:none;
    }
    .spellInput:focus{border-color:var(--focus)}

    .hintChips{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:12px; border-radius:16px; border:1px solid var(--line);
      background:#0a1324;
      min-height:56px;
    }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:42px; height:42px; padding:0 10px;
      border-radius:14px;
      border:1px solid rgba(145,164,199,.25);
      background:#111b2e;
      color:var(--text);
      font-size:18px;
      user-select:none;
    }

    .mcqWrap{ display:grid; gap:10px; margin-top:8px; }
    .optionBtn{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(145,164,199,.25);
      background:#0a1324;
      color:var(--text);
      cursor:pointer;
      transition:.12s transform, .12s background, .12s border-color;
      user-select:none;
      font-size:15px;
    }
    .optionBtn:hover{background:#111b2e}
    .optionBtn:active{transform:translateY(1px)}
    .optionBtn.correct{border-color:rgba(46,204,113,.85)}
    .optionBtn.wrong{border-color:rgba(255,92,92,.9)}
    .optionBtn:disabled{opacity:.82; cursor:not-allowed}

    .partsGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 560px){
      .partsGrid{grid-template-columns:1fr 1fr 1fr;}
    }
    .partCard{
      border:1px solid rgba(145,164,199,.18);
      border-radius:14px;
      background:rgba(10,19,36,.55);
      padding:10px 10px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .partCard label{cursor:pointer; line-height:1.3}
    .partTitle{font-weight:700}
    .partMeta{color:var(--muted); font-size:12px; margin-top:4px}

    details{
      border:1px solid rgba(145,164,199,.18);
      border-radius:16px;
      background:rgba(10,19,36,.55);
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      color:var(--text);
      font-weight:700;
      outline:none;
    }
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th, td{
      border-bottom:1px solid rgba(35,53,83,.5);
      padding:8px 6px;
      font-size:13px;
      vertical-align:top;
    }
    th{color:var(--muted); font-weight:600; text-align:left}
    .right{text-align:right}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(145,164,199,.25);
      background:#0a1324;
      color:var(--muted);
      font-size:12px;
    }
    .controlsGrid{display:grid; gap:10px; grid-template-columns:1fr;}
    @media (min-width: 520px){ .controlsGrid{grid-template-columns: 1fr 1fr} }

    select, input[type="range"], textarea{
      background:#0a1324;
      color:var(--text);
      border:1px solid rgba(145,164,199,.25);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
    }
    select:focus, textarea:focus{border-color:var(--focus)}
    textarea{width:100%; min-height:120px; resize:vertical; font-size:13px; line-height:1.5}
    .rangeRow{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>å–®å­—ç·´ç¿’ï¼šæ‹¼å­—ï¼é¸æ“‡é¡Œï¼è½åŠ›ï¼éŒ¯é¡Œæœ¬ï¼ˆPart é¡Œåº«ï¼‰</h1>
        <div class="sub">
          å…ˆå‹¾é¸è¦ç·´ç¿’çš„ Partï¼ˆå¯å¤šé¸ï¼‰â†’ é–‹å§‹ã€‚<br/>
          æ‹¼å­—æ¨¡å¼ï¼šç”¨éµç›¤è¼¸å…¥è‹±æ–‡ï¼ŒæŒ‰ <span class="kbd">Enter</span> æª¢æŸ¥ã€‚é¸æ“‡é¡Œæ¨¡å¼ï¼š4 é¸ 1ã€‚<br/>
          ç™¼éŸ³ä½¿ç”¨ Web Speech APIï¼ˆChrome/Edge è¼ƒç©©ï¼‰ï¼šç¬¬ä¸€æ¬¡é€šå¸¸è¦å…ˆæŒ‰ä¸€æ¬¡ã€ŒğŸ”Š è½ç™¼éŸ³ã€æ‰æœƒå…è¨±å‡ºè²ã€‚
        </div>
      </div>
      <div class="row">
        <span class="pill" id="statPill">å°šæœªé–‹å§‹</span>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:700; margin-bottom:6px;">â‘  é¸æ“‡è¦ç·´ç¿’çš„ Partï¼ˆå¯å¤šé¸ï¼‰</div>
            <div class="small">
              ä½ å¯ä»¥å‹¾å¤šå€‹ Part çµ„åˆé¡Œåº«ã€‚ä¹Ÿå¯ä»¥å‹¾ã€Œåªç·´éŒ¯é¡Œã€åªå‡ºéŒ¯é¡Œæœ¬å…§çš„é¡Œç›®ï¼ˆæœƒä¾ Part ç¯„åœéæ¿¾ï¼‰ã€‚
            </div>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnSelectAll">å…¨é¸</button>
            <button class="btn ghost" id="btnSelectNone">å…¨ä¸é¸</button>
            <button class="btn ghost" id="btnInvert">åé¸</button>
          </div>
        </div>

        <div class="partsGrid" id="partsGrid"></div>

        <div class="row" style="justify-content:space-between; margin-top:10px;">
          <span class="pill" id="selStats">å·²é¸ 0 å€‹ Partï¼Œå…± 0 å€‹å–®å­—</span>
          <label class="toggle small" title="åªç”¨éŒ¯é¡Œæœ¬ä¸­çš„å–®å­—å‡ºé¡Œ">
            <input type="checkbox" id="chkWrongOnly" />
            åªç·´éŒ¯é¡Œ
          </label>
        </div>

        <div class="sep"></div>

        <div class="controlsGrid">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <button class="btn primary" id="btnStart">é–‹å§‹ï¼ˆéš¨æ©Ÿé †åºï¼‰</button>
              <button class="btn" id="btnResetSession">é‡ç½®æœ¬è¼ª</button>
            </div>
            <div class="row">
              <span class="badge">æ¨¡å¼</span>
              <select id="selMode" title="æ‹¼å­—ï¼šéµç›¤è¼¸å…¥ï½œé¸æ“‡é¡Œï¼š4é¸1ï½œæ··åˆï¼šäº¤éŒ¯å‡ºé¡Œ">
                <option value="spelling">æ‹¼å­—ï¼ˆéµç›¤è¼¸å…¥ï¼‰</option>
                <option value="mcq">é¸æ“‡é¡Œï¼ˆ4é¸1ï¼‰</option>
                <option value="mixed">æ··åˆï¼ˆäº¤éŒ¯ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="row" style="justify-content:space-between">
            <div class="row">
              <label class="toggle small" title="æ¯é¡Œè¼‰å…¥å¾Œè‡ªå‹•å”¸è‹±æ–‡ï¼ˆéœ€ç€è¦½å™¨å…è¨±ï¼‰">
                <input type="checkbox" id="chkAutoSpeak" />
                è‡ªå‹•å”¸é¡Œ
              </label>
              <label class="toggle small" title="é¡¯ç¤ºæ‰“æ•£å­—æ¯ä½œç‚ºæç¤º">
                <input type="checkbox" id="chkShowScramble" checked />
                é¡¯ç¤ºæ‰“æ•£å­—æ¯
              </label>
            </div>

            <div class="row">
              <span class="badge">ç™¼éŸ³èªé€Ÿ</span>
              <input type="range" id="rngRate" min="0.6" max="1.2" step="0.05" value="0.95" />
              <span class="small" id="rateText">0.95x</span>
            </div>
          </div>

          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="badge">èªéŸ³</span>
              <select id="selVoice" title="è‹¥çœ‹ä¸åˆ°èªéŸ³ï¼Œåˆ·æ–°é é¢æˆ–ç­‰ 1~2 ç§’å¾Œå†é–‹ä¸‹æ‹‰"></select>
            </div>

            <details style="width:100%">
              <summary>ï¼ˆé¸å¡«ï¼‰è‡ªè¨‚è¿½åŠ å–®å­—</summary>
              <div class="small" style="margin-top:8px;">
                æ¯è¡Œä¸€çµ„ã€Œè‹±æ–‡ - ä¸­æ–‡ã€ã€‚é–‹å§‹æ™‚æœƒå’Œä½ å‹¾é¸çš„ Part åˆä½µå‡ºé¡Œã€‚
              </div>
              <textarea id="customInput" placeholder="ä¾‹ï¼š
cell membrane - ç´°èƒè†œ
ribosome - æ ¸ç³–é«”"></textarea>
            </details>
          </div>
        </div>

        <div class="sep"></div>

        <details id="wrongbookDetails">
          <summary>éŒ¯é¡Œæœ¬ï¼ˆè‡ªå‹•æ”¶é›†ï¼‰ <span class="pill" id="wrongCountPill">0</span></summary>

          <div class="row" style="margin-top:10px; justify-content:space-between">
            <div class="row">
              <button class="btn danger" id="btnWrongClear">æ¸…ç©ºéŒ¯é¡Œæœ¬</button>
              <button class="btn" id="btnWrongExport">åŒ¯å‡º CSV</button>
            </div>
            <div class="small">éŒ¯é¡Œæœ¬æœƒå­˜åœ¨ç€è¦½å™¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚</div>
          </div>

          <div style="overflow:auto;">
            <table id="wrongTable">
              <thead>
                <tr>
                  <th>è‹±æ–‡</th>
                  <th>ä¸­æ–‡</th>
                  <th class="right">éŒ¯èª¤æ¬¡æ•¸</th>
                  <th class="right">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <div class="card">
        <div class="gameTop">
          <div class="row">
            <span class="pill" id="idxPill">ç¬¬ 0/0 é¡Œ</span>
            <span class="pill" id="scorePill">åˆ†æ•¸ 0</span>
            <span class="pill" id="modePill">æ¨¡å¼ï¼šâ€”</span>
          </div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>

        <div class="sep"></div>

        <p class="cn" id="cnText">è«‹å…ˆåœ¨å·¦å´å‹¾é¸ Partï¼ŒæŒ‰ã€Œé–‹å§‹ã€</p>

        <div class="row" style="margin-top:10px; justify-content:space-between">
          <div class="row">
            <button class="btn" id="btnSpeak">ğŸ”Š è½ç™¼éŸ³</button>
            <button class="btn ghost" id="btnSpeakSlow">ğŸ¢ æ…¢é€Ÿ</button>
          </div>
          <div class="small" id="wordMeta"></div>
        </div>

        <div class="sep"></div>

        <div id="panel"></div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="msg" id="msg"></div>
          <div class="row">
            <button class="btn" id="btnHint">æç¤º</button>
            <button class="btn ghost" id="btnReveal">é¡¯ç¤ºç­”æ¡ˆ</button>
            <button class="btn" id="btnSkip">è·³é</button>
            <button class="btn primary" id="btnNext">ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="small">
          å¿«æ·éµï¼šæ‹¼å­—æ¨¡å¼ <span class="kbd">Enter</span> æª¢æŸ¥ã€<span class="kbd">Esc</span> æ¸…ç©ºã€<span class="kbd">Alt</span>+<span class="kbd">S</span> ç™¼éŸ³
        </div>
      </div>
    </div>
  </div>

  <script>
    const PARTS = [
      { name: "Part1", items: [
        {en:"kingdom", zh:"ç•Œ"},
        {en:"phylum", zh:"é–€(å–®æ•¸)"},
        {en:"class", zh:"ç¶±"},
        {en:"order", zh:"ç›®"},
        {en:"family", zh:"ç§‘"},
        {en:"genus", zh:"å±¬"},
        {en:"Amniote", zh:"ç¾Šè†œå‹•ç‰©"},
        {en:"Cambrian explosion", zh:"å¯’æ­¦ç´€å¤§çˆ†ç™¼"},
        {en:"coral reefs", zh:"çŠç‘šç¤"},
        {en:"krill", zh:"ç£·è¦"},
      ]},
      { name: "Part2", items: [
        {en:"nautiluses", zh:"é¸šéµ¡èº"},
        {en:"salamanders", zh:"è ‘èˆ"},
        {en:"larve", zh:"å¹¼èŸ²"},
        {en:"nymph", zh:"è‹¥èŸ²"},
        {en:"Allantois", zh:"å°¿å›Š"},
        {en:"amniotic sac", zh:"ç¾Šè†œå›Š"},
        {en:"chorion", zh:"çµ¨æ¯›è†œ"},
        {en:"Malpighian tubules", zh:"é¦¬æ°ç®¡"},
        {en:"tube feet", zh:"ç®¡è¶³"},
        {en:"water vascular system", zh:"æ°´ç®¡ç³»çµ±"},
      ]},
      { name: "Part3", items: [
        {en:"sea cucumber", zh:"æµ·åƒ"},
        {en:"sea urchin", zh:"æµ·è†½"},
        {en:"albumen", zh:"è›‹ç™½"},
        {en:"Class Arachnida", zh:"è››å½¢ç¶±"},
        {en:"Phylum Cnidaria", zh:"åˆºèƒå‹•ç‰©é–€"},
        {en:"coelom", zh:"é«”è…”"},
        {en:"Coelomate", zh:"é«”è…”å‹•ç‰©"},
        {en:"Pseudocoelomate", zh:"å‡é«”è…”å‹•ç‰©"},
        {en:"Class Hirudinea", zh:"è›­äºç¶±"},
        {en:"Order Blattodea", zh:"èœšè Šç›®"},
      ]},
      { name: "Part4", items: [
        {en:"mandible", zh:"ä¸‹é œéª¨"},
        {en:"Marsupial", zh:"æœ‰è¢‹ç›®"},
        {en:"Phylum Mollusca", zh:"è»Ÿé«”å‹•ç‰©é–€"},
        {en:"pharyngeal slits", zh:"å’½è£‚"},
        {en:"Phylum Porifera", zh:"å¤šå­”å‹•ç‰©é–€"},
        {en:"squid", zh:"çƒè³Š"},
        {en:"Squamates", zh:"æœ‰é±—ç›®"},
        {en:"tracheal tubes", zh:"æ°£ç®¡"},
        {en:"Phylum Echinodermata", zh:"æ£˜çš®å‹•ç‰©é–€"},
        {en:"Order Carnivora", zh:"é£Ÿè‚‰ç›®"},
      ]},
      { name: "Part5", items: [
        {en:"Tunicate", zh:"æµ·é˜"},
        {en:"Urodela", zh:"æœ‰å°¾ç›®"},
        {en:"centipede", zh:"èœˆèš£"},
        {en:"millipede", zh:"é¦¬é™¸"},
        {en:"Apoda", zh:"ç„¡è¶³ç›®"},
        {en:"phylum Arthropoda", zh:"ç¯€è‚¢å‹•ç‰©é–€"},
        {en:"Class Cephalopoda", zh:"é ­è¶³ç¶±"},
        {en:"Class Gastropoda", zh:"è…¹è¶³ç¶±"},
        {en:"Myriapoda", zh:"å¤šè¶³ç¶±"},
      ]},
      { name: "Part6", items: [
        {en:"Tetrapods", zh:"å››è¶³å‹•ç‰©äºç¶±"},
        {en:"platypus", zh:"é´¨å˜´ç¸"},
        {en:"Class Actinopterygii", zh:"è¼»é°­é­šç¶±"},
        {en:"Class Sarcopterygii", zh:"è‚‰é°­é­šç¶±"},
        {en:"Archaeopteryx", zh:"å§‹ç¥–é³¥"},
        {en:"Order Chiroptera", zh:"ç¿¼æ‰‹ç›®"},
        {en:"phylum Chiroptera", zh:"ç¿¼æ‰‹é–€"},
        {en:"Order Coleoptera", zh:"é˜ç¿…ç›®"},
        {en:"Order Hemiptera", zh:"åŠç¿…ç›®"},
        {en:"Order Hymanoptera", zh:"è†œç¿…ç›®"},
      ]},
      { name: "Part7", items: [
        {en:"Order Isoptera", zh:"ç­‰ç¿…ä¸‹ç›®"},
        {en:"Order Lepidoptera", zh:"é±—ç¿…ç›®"},
        {en:"Pterosaurs", zh:"ç¿¼é¾é¡"},
        {en:"metamorphosis", zh:"å®Œå…¨è®Šæ…‹"},
        {en:"incomplete metamorphosis", zh:"ä¸å®Œå…¨è®Šæ…‹"},
        {en:"Order Lagomorpha", zh:"å…”å½¢ç›®"},
        {en:"ectotherms", zh:"å¤–æº«å‹•ç‰©"},
        {en:"endotherms", zh:"å…§æº«å‹•ç‰©"},
        {en:"Class Amphibian", zh:"å…©æ£²å‹•ç‰©ç¶±"},
        {en:"Order Cetacean", zh:"é¯¨ç›®"},
      ]},
      { name: "Part8", items: [
        {en:"Crustacea", zh:"ç”²æ®¼äºé–€"},
        {en:"Chondrichthyan", zh:"è»Ÿéª¨é­šç¶±"},
        {en:"Osteichthyes", zh:"ç¡¬éª¨é­šç¶±"},
        {en:"Class Echinoidea", zh:"æµ·è†½ç¶±"},
        {en:"exoskeleton", zh:"å¤–éª¨éª¼"},
        {en:"Order Odonata", zh:"èœ»è›‰ç›®"},
        {en:"pelvic fins", zh:"è…¹é°­"},
        {en:"Class Oligochaeta", zh:"å¯¡æ¯›äºç¶±"},
        {en:"Class Polychaeta", zh:"å¤šæ¯›ç¶±"},
        {en:"Phylum Annelida", zh:"ç’°ç¯€å‹•ç‰©é–€"},
      ]},
      { name: "Part9", items: [
        {en:"chelicera", zh:"è¯è‚¢"},
        {en:"choanocytes", zh:"è¥Ÿç´°èƒ"},
        {en:"Crinoidea", zh:"æµ·ç™¾åˆç¶±"},
        {en:"Class Anthozoa", zh:"çŠç‘šç¶±"},
        {en:"Class Asteroidea", zh:"æµ·æ˜Ÿç¶±"},
        {en:"radial symmetry", zh:"è¼»å°„å°ç¨±"},
        {en:"phylum Platyhelminthes", zh:"æ‰å½¢å‹•ç‰©é–€"},
        {en:"planarian", zh:"æ¸¦èŸ²"},
        {en:"plankton", zh:"æµ®æ¸¸ç”Ÿç‰©"},
        {en:"Class Cubozoa", zh:"ç®±å‹æ°´æ¯"},
      ]},
      { name: "Part10", items: [
        {en:"Class Scyphozoa", zh:"ç¼½æ°´æ¯ç¶±"},
        {en:"tentacle", zh:"è§¸æ‰‹"},
        {en:"Class Cestoda", zh:"çµ›èŸ²ç¶±"},
        {en:"chordata", zh:"è„Šç´¢å‹•ç‰©é–€"},
        {en:"Phylum Nematoda", zh:"ç·šèŸ²é–€"},
        {en:"Order Anura", zh:"ç„¡å°¾ç›®"},
        {en:"Monotremata", zh:"å–®å­”ç›®"},
        {en:"bilateral symmetry", zh:"é›™å´å°ç¨±"},
        {en:"Class Bivalvia", zh:"é›™æ®¼ç¶±"},
        {en:"trilobite", zh:"ä¸‰è‘‰èŸ²"},
      ]},
      { name: "Part11", items: [
        {en:"Triploblastic animals", zh:"ä¸‰èƒšå±¤å‹•ç‰©"},
        {en:"Order Artiodactyla", zh:"å¶è¹„ç›®"},
        {en:"Order Perissodacyla", zh:"å¥‡è¹„ç›®"},
        {en:"Order Proboscidea", zh:"é•·é¼»ç›®"},
        {en:"Cephalochordata", zh:"é ­ç´¢å‹•ç‰©äºé–€"},
        {en:"Order Primates", zh:"éˆé•·ç›®"},
        {en:"mesoderm", zh:"ä¸­èƒšå±¤"},
        {en:"mesohyl", zh:"ä¸­è³ªå±¤"},
        {en:"Amoebocyte", zh:"é˜¿ç±³å·´"},
        {en:"brittle star", zh:"é™½é‚è¶³"},
      ]},
      { name: "Part12", items: [
        {en:"radula", zh:"é½’èˆŒ"},
        {en:"Order Rodentia", zh:"å›“é½’ç›®"},
      ]},
    ];

    const $ = (sel) => document.querySelector(sel);

    function normalizeWord(w){
      return (w || "").toLowerCase().replace(/[^a-z]/g, "");
    }

    function shuffleArray(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function scrambleLetters(word){
      const letters = word.split("");
      if (letters.length <= 1) return letters;
      let tries = 0;
      let out = letters;
      while (tries < 10){
        out = shuffleArray(letters);
        if (out.join("") !== letters.join("")) break;
        tries++;
      }
      return out;
    }

    function parseCustomList(text){
      const lines = (text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const items = [];
      const bad = [];

      for (const line of lines){
        let parts = null;
        if (line.includes("\t")) parts = line.split("\t");
        else if (line.includes(" - ")) parts = line.split(" - ");
        else if (line.includes("-")){
          const idx = line.indexOf("-");
          parts = [line.slice(0, idx), line.slice(idx + 1)];
        } else if (line.includes(":")){
          const idx = line.indexOf(":");
          parts = [line.slice(0, idx), line.slice(idx + 1)];
        } else if (line.includes(",")){
          const idx = line.indexOf(",");
          parts = [line.slice(0, idx), line.slice(idx + 1)];
        }

        if (!parts || parts.length < 2){ bad.push(line); continue; }

        const en = (parts[0] || "").trim();
        const zh = parts.slice(1).join(" ").trim();
        const norm = normalizeWord(en);

        if (!en || !zh || !norm){ bad.push(line); continue; }
        items.push({ en, zh, norm, part: "Custom" });
      }
      return { items, bad };
    }

    const storageWrongKey = "vocab_trainer_wrongbook_parts_v1";
    const storageSettingsKey = "vocab_trainer_settings_parts_v1";

    function loadJSON(key, fallback){
      try{
        const t = localStorage.getItem(key);
        return t ? JSON.parse(t) : fallback;
      }catch{ return fallback; }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    let wrongbook = loadJSON(storageWrongKey, {});
    let deck = [];
    let order = [];
    let idx = 0;

    let score = 0;
    let correct = 0;
    let attempted = 0;

    let current = null;
    let qType = "spelling";
    let locked = true;

    let mcqOptions = [];
    let mcqAnswered = false;

    let voices = [];
    let voiceName = "";

    function setMsg(text, type=""){
      const el = $("#msg");
      el.textContent = text || "";
      el.className = "msg" + (type ? " " + type : "");
    }

    function updateTop(){
      $("#idxPill").textContent = `ç¬¬ ${order.length ? Math.min(idx+1, order.length) : 0}/${order.length} é¡Œ`;
      $("#scorePill").textContent = `åˆ†æ•¸ ${score}`;
      $("#statPill").textContent = order.length
        ? `ç­”å° ${correct} / ä½œç­” ${attempted} / å…± ${order.length}`
        : "å°šæœªé–‹å§‹";
      $("#modePill").textContent = `æ¨¡å¼ï¼š${qType === "spelling" ? "æ‹¼å­—" : "é¸æ“‡é¡Œ"}`;

      const pct = order.length ? (idx / order.length) * 100 : 0;
      $("#bar").style.width = `${Math.min(100, Math.max(0, pct))}%`;

      const wrongCount = Object.keys(wrongbook).length;
      $("#wrongCountPill").textContent = wrongCount;
    }

    function updateWordMeta(){
      if (!current){
        $("#wordMeta").textContent = "";
        return;
      }
      $("#wordMeta").textContent = `é¡Œåº«ï¼š${current.part}ï½œå­—æ¯æ•¸ï¼š${current.norm.length}`;
    }

    function buildPartsUI(){
      const grid = $("#partsGrid");
      grid.innerHTML = "";

      const settings = loadJSON(storageSettingsKey, {});
      const savedSelected = new Set(settings.selectedParts || []);

      for (const p of PARTS){
        const id = `chk_${p.name}`;
        const wrap = document.createElement("div");
        wrap.className = "partCard";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = savedSelected.size ? savedSelected.has(p.name) : true;

        const label = document.createElement("label");
        label.htmlFor = id;

        const title = document.createElement("div");
        title.className = "partTitle";
        title.textContent = p.name;

        const meta = document.createElement("div");
        meta.className = "partMeta";
        meta.textContent = `${p.items.length} å€‹å–®å­—`;

        label.appendChild(title);
        label.appendChild(meta);

        cb.addEventListener("change", () => {
          updateSelectedStats();
          saveSettings();
        });

        wrap.appendChild(cb);
        wrap.appendChild(label);
        grid.appendChild(wrap);
      }

      updateSelectedStats();
    }

    function getSelectedParts(){
      const selected = [];
      for (const p of PARTS){
        const cb = document.getElementById(`chk_${p.name}`);
        if (cb && cb.checked) selected.push(p.name);
      }
      return selected;
    }

    function updateSelectedStats(){
      const selected = new Set(getSelectedParts());
      let count = 0;
      for (const p of PARTS){
        if (selected.has(p.name)) count += p.items.length;
      }
      $("#selStats").textContent = `å·²é¸ ${selected.size} å€‹ Partï¼Œå…± ${count} å€‹å–®å­—`;
    }

    function markWrong(item){
      const k = item.norm;
      if (!wrongbook[k]){
        wrongbook[k] = { en: item.en, zh: item.zh, wrongCount: 0, lastWrongAt: "" };
      }
      wrongbook[k].en = item.en;
      wrongbook[k].zh = item.zh;
      wrongbook[k].wrongCount += 1;
      wrongbook[k].lastWrongAt = new Date().toISOString();

      saveJSON(storageWrongKey, wrongbook);
      renderWrongTable();
      updateTop();
    }

    function removeFromWrongbook(norm){
      if (wrongbook[norm]){
        delete wrongbook[norm];
        saveJSON(storageWrongKey, wrongbook);
        renderWrongTable();
        updateTop();
      }
    }

    function clearWrongbook(){
      wrongbook = {};
      saveJSON(storageWrongKey, wrongbook);
      renderWrongTable();
      updateTop();
    }

    function renderWrongTable(){
      const tbody = $("#wrongTable tbody");
      tbody.innerHTML = "";

      const entries = Object.entries(wrongbook)
        .map(([norm, v]) => ({ norm, ...v }))
        .sort((a,b) => (b.wrongCount - a.wrongCount) || a.en.localeCompare(b.en));

      if (entries.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="small">ç›®å‰æ²’æœ‰éŒ¯é¡Œ ğŸ‰</td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const e of entries){
        const tr = document.createElement("tr");

        const tdEn = document.createElement("td");
        tdEn.className = "mono";
        tdEn.textContent = e.en;

        const tdZh = document.createElement("td");
        tdZh.textContent = e.zh;

        const tdCnt = document.createElement("td");
        tdCnt.className = "right";
        tdCnt.textContent = e.wrongCount;

        const tdAct = document.createElement("td");
        tdAct.className = "right";
        const btn = document.createElement("button");
        btn.className = "btn ghost";
        btn.textContent = "æ¨™è¨˜å·²æœƒ";
        btn.addEventListener("click", () => removeFromWrongbook(e.norm));
        tdAct.appendChild(btn);

        tr.appendChild(tdEn);
        tr.appendChild(tdZh);
        tr.appendChild(tdCnt);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      }
    }

    function exportWrongbookCSV(){
      const entries = Object.entries(wrongbook)
        .map(([norm, v]) => ({ norm, ...v }))
        .sort((a,b) => (b.wrongCount - a.wrongCount) || a.en.localeCompare(b.en));

      const rows = [
        ["english","chinese","wrongCount","lastWrongAt","norm"],
        ...entries.map(e => [e.en, e.zh, String(e.wrongCount), e.lastWrongAt || "", e.norm])
      ];

      const csv = rows.map(r =>
        r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(",")
      ).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "wrongbook.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function refreshVoices(){
      voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      const sel = $("#selVoice");
      sel.innerHTML = "";

      if (!voices || voices.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "ï¼ˆç„¡å¯ç”¨èªéŸ³ / è«‹ç¨ç­‰æˆ–åˆ·æ–°ï¼‰";
        sel.appendChild(opt);
        return;
      }

      const sorted = voices.slice().sort((a,b) => {
        const aEn = (a.lang || "").toLowerCase().startsWith("en");
        const bEn = (b.lang || "").toLowerCase().startsWith("en");
        if (aEn !== bEn) return bEn - aEn;
        return (a.name || "").localeCompare(b.name || "");
      });

      for (const v of sorted){
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        sel.appendChild(opt);
      }

      const settings = loadJSON(storageSettingsKey, {});
      const wanted = voiceName || settings.voiceName || "";
      if (wanted && sorted.some(v => v.name === wanted)){
        sel.value = wanted;
        voiceName = wanted;
      } else {
        const firstEn = sorted.find(v => (v.lang || "").toLowerCase().startsWith("en"));
        sel.value = firstEn ? firstEn.name : sorted[0].name;
        voiceName = sel.value;
      }
    }

    function speak(text, rateOverride=null){
      if (!window.speechSynthesis || !text) {
        setMsg("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³ï¼ˆspeechSynthesisï¼‰ã€‚", "warn");
        return;
      }
      window.speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      const rate = rateOverride ?? parseFloat($("#rngRate").value || "1");
      utter.rate = Math.min(2, Math.max(0.2, rate));

      const chosenName = $("#selVoice").value || voiceName;
      const v = voices.find(x => x.name === chosenName);
      if (v) utter.voice = v;

      window.speechSynthesis.speak(utter);
    }

    function renderPanel(){
      const panel = $("#panel");
      panel.innerHTML = "";
      if (!current){
        panel.innerHTML = `<div class="small">å°šæœªé–‹å§‹</div>`;
        return;
      }
      if (qType === "spelling") panel.appendChild(renderSpellingPanel());
      else panel.appendChild(renderMcqPanel());

      if ($("#chkShowScramble").checked){
        panel.appendChild(renderScrambleHint());
      }
    }

    function renderSpellingPanel(){
      const wrap = document.createElement("div");
      wrap.className = "grid";

      const box = document.createElement("div");
      box.className = "spellBox";

      const input = document.createElement("input");
      input.className = "spellInput";
      input.id = "spellInput";
      input.placeholder = "è«‹è¼¸å…¥è‹±æ–‡æ‹¼å­—ï¼ŒEnter æª¢æŸ¥â€¦";
      input.autocomplete = "off";
      input.autocapitalize = "off";
      input.spellcheck = false;
      input.disabled = locked;

      const btnCheck = document.createElement("button");
      btnCheck.className = "btn ok";
      btnCheck.id = "btnSpellCheck";
      btnCheck.textContent = "æª¢æŸ¥ï¼ˆEnterï¼‰";
      btnCheck.disabled = locked;

      const btnClear = document.createElement("button");
      btnClear.className = "btn ghost";
      btnClear.id = "btnSpellClear";
      btnClear.textContent = "æ¸…ç©ºï¼ˆEscï¼‰";
      btnClear.disabled = locked;

      btnCheck.addEventListener("click", () => checkSpelling());
      btnClear.addEventListener("click", () => {
        input.value = "";
        input.focus();
        setMsg("", "");
      });

      box.appendChild(input);
      box.appendChild(btnCheck);
      box.appendChild(btnClear);

      const tip = document.createElement("div");
      tip.className = "small";
      tip.innerHTML = `æç¤ºï¼šæŒ‰ <span class="kbd">Alt</span>+<span class="kbd">S</span> å¯ä»¥è½ç™¼éŸ³ã€‚`;

      wrap.appendChild(box);
      wrap.appendChild(tip);

      setTimeout(() => { if (!locked) input.focus(); }, 0);
      return wrap;
    }

    function renderScrambleHint(){
      const letters = scrambleLetters(current.norm);
      const hint = document.createElement("div");
      hint.className = "hintChips";
      hint.title = "æ‰“æ•£å­—æ¯æç¤º";
      for (const ch of letters){
        const s = document.createElement("span");
        s.className = "chip";
        s.textContent = ch.toUpperCase();
        hint.appendChild(s);
      }
      return hint;
    }

    function renderMcqPanel(){
      const wrap = document.createElement("div");
      wrap.className = "mcqWrap";
      mcqAnswered = false;

      mcqOptions.forEach((opt, i) => {
        const b = document.createElement("button");
        b.className = "optionBtn";
        b.type = "button";
        b.textContent = `${String.fromCharCode(65+i)}. ${opt.en}`;
        b.disabled = locked;
        b.addEventListener("click", () => chooseMcq(opt.norm, b));
        wrap.appendChild(b);
      });
      return wrap;
    }

    function chooseQType(){
      const mode = $("#selMode").value;
      if (mode === "spelling") return "spelling";
      if (mode === "mcq") return "mcq";
      return (Math.random() < 0.6) ? "spelling" : "mcq";
    }

    function buildDeckFromSelection(){
      const selectedParts = new Set(getSelectedParts());
      if (selectedParts.size === 0){
        deck = [];
        return { ok:false, msg:"è«‹è‡³å°‘å‹¾é¸ 1 å€‹ Partã€‚"};
      }

      const items = [];
      for (const p of PARTS){
        if (!selectedParts.has(p.name)) continue;
        for (const it of p.items){
          const norm = normalizeWord(it.en);
          if (!norm) continue;
          items.push({ en: it.en, zh: it.zh, norm, part: p.name });
        }
      }

      const customText = ($("#customInput").value || "").trim();
      const { items: customItems, bad } = parseCustomList(customText);
      if (customItems.length){
        for (const it of customItems) items.push(it);
      }

      const seen = new Set();
      deck = items.filter(it => {
        if (seen.has(it.norm)) return false;
        seen.add(it.norm);
        return true;
      });

      if (deck.length === 0){
        return { ok:false, msg:"é¸åˆ°çš„ Part / è‡ªè¨‚æ¸…å–®æ²’æœ‰å¯ç”¨å–®å­—ã€‚"};
      }

      return { ok:true, msg: bad && bad.length ? `è‡ªè¨‚å–®å­—æœ‰ ${bad.length} è¡Œæ ¼å¼ä¸æ­£ç¢ºå·²å¿½ç•¥ã€‚` : "" };
    }

    function buildOrderFromDeck(){
      const wrongOnly = $("#chkWrongOnly").checked;
      if (!wrongOnly){
        order = shuffleArray([...Array(deck.length).keys()]);
        return;
      }

      const normToIndex = new Map(deck.map((it, i) => [it.norm, i]));
      const indices = Object.keys(wrongbook)
        .map(norm => normToIndex.get(norm))
        .filter(i => typeof i === "number");

      order = indices.length ? shuffleArray(indices) : shuffleArray([...Array(deck.length).keys()]);
    }

    function prepareMcqOptions(){
      const pool = deck.filter(it => it.norm !== current.norm);
      const picks = shuffleArray(pool).slice(0, 3);
      const opts = [{en: current.en, norm: current.norm}, ...picks.map(p => ({en: p.en, norm: p.norm}))];
      mcqOptions = shuffleArray(opts);
    }

    function loadQuestion(){
      if (!deck.length || idx >= order.length){
        locked = true;
        $("#cnText").textContent = "ğŸ‰ å·²å®Œæˆï¼ä½ å¯ä»¥é‡æ–°é–‹å§‹æˆ–æ› Part ç¯„åœã€‚";
        $("#panel").innerHTML = `<div class="small">å®Œæˆ</div>`;
        $("#bar").style.width = "100%";
        setMsg(`å®Œæˆï¼ç­”å° ${correct} / ä½œç­” ${attempted} / åˆ†æ•¸ ${score}`, "ok");
        updateTop();
        updateWordMeta();
        return;
      }

      current = deck[order[idx]];
      qType = chooseQType();
      locked = false;
      mcqAnswered = false;

      $("#cnText").textContent = current.zh;
      setMsg("", "");
      updateWordMeta();

      if (qType === "mcq") prepareMcqOptions();
      renderPanel();
      updateTop();

      if ($("#chkAutoSpeak").checked){
        speak(current.en);
      } else if (qType === "spelling"){
        setTimeout(() => {
          const inp = $("#spellInput");
          if (inp && !locked) inp.focus();
        }, 0);
      }
    }

    function startGame(){
      const result = buildDeckFromSelection();
      if (!result.ok){
        setMsg(result.msg, "bad");
        return;
      }

      idx = 0;
      score = 0;
      correct = 0;
      attempted = 0;

      buildOrderFromDeck();
      saveSettings();

      if (result.msg) setMsg(`å·²é–‹å§‹ã€‚${result.msg}`, "warn");
      else setMsg(`å·²é–‹å§‹ï¼é¡Œåº«å…± ${deck.length} å€‹å–®å­—ã€‚`, "ok");

      loadQuestion();
    }

    function resetSession(){
      idx = 0;
      score = 0;
      correct = 0;
      attempted = 0;
      setMsg("å·²é‡ç½®æœ¬è¼ªï¼ˆä»ä½¿ç”¨ç›®å‰ Part ç¯„åœï¼‰ã€‚", "warn");
      buildOrderFromDeck();
      loadQuestion();
    }

    function next(){
      if (!deck.length) return;
      idx++;
      loadQuestion();
    }

    function skip(){
      if (!current || locked) return;
      attempted++;
      score = Math.max(0, score - 1);
      setMsg(`â­ï¸ å·²è·³éï¼ˆåˆ†æ•¸ -1ï¼‰ã€‚ç­”æ¡ˆï¼š${current.en}`, "warn");
      locked = true;
      updateTop();
      lockCurrentUI();
    }

    function reveal(){
      if (!current) return;
      locked = true;
      updateTop();
      lockCurrentUI();
      setMsg(`ç­”æ¡ˆï¼š${current.en}`, "warn");
      const inp = $("#spellInput");
      if (inp) inp.value = current.en;
      if (qType === "mcq"){
        const buttons = Array.from($("#panel").querySelectorAll(".optionBtn"));
        for (const b of buttons){
          const txt = b.textContent.split(". ").slice(1).join(". ");
          if (normalizeWord(txt) === current.norm) b.classList.add("correct");
        }
      }
    }

    function hint(){
      if (!current || locked) return;
      score = Math.max(0, score - 1);

      if (qType === "spelling"){
        const inp = $("#spellInput");
        if (!inp) return;
        const typedNorm = normalizeWord(inp.value);
        const nextChar = current.norm[typedNorm.length] || current.norm[0] || "";
        if (typedNorm.length === 0){
          inp.value = nextChar;
        } else if (nextChar){
          inp.value = inp.value + nextChar;
        }
        inp.focus();
        setMsg("å·²æç¤ºä¸€é»é»ï¼ˆåˆ†æ•¸ -1ï¼‰", "warn");
      } else {
        const buttons = Array.from($("#panel").querySelectorAll(".optionBtn"));
        const candidates = buttons.filter(b => {
          const txt = b.textContent.split(". ").slice(1).join(". ");
          return normalizeWord(txt) !== current.norm && !b.disabled;
        });
        if (candidates.length){
          const kill = candidates[Math.floor(Math.random() * candidates.length)];
          kill.disabled = true;
          setMsg("å·²å¹«ä½ æ’é™¤ä¸€å€‹éŒ¯èª¤é¸é …ï¼ˆåˆ†æ•¸ -1ï¼‰", "warn");
        } else {
          setMsg("æ²’æœ‰å¯æ’é™¤çš„é¸é …äº†ï¼ˆåˆ†æ•¸ -1ï¼‰", "warn");
        }
      }

      updateTop();
    }

    function lockCurrentUI(){
      const inp = $("#spellInput");
      const c1 = $("#btnSpellCheck");
      const c2 = $("#btnSpellClear");
      if (inp) inp.disabled = true;
      if (c1) c1.disabled = true;
      if (c2) c2.disabled = true;

      const buttons = Array.from($("#panel").querySelectorAll(".optionBtn"));
      for (const b of buttons) b.disabled = true;
    }

    function checkSpelling(){
      if (!current || locked) return;
      const inp = $("#spellInput");
      if (!inp) return;

      const raw = inp.value.trim();
      const typed = normalizeWord(raw);

      if (!typed){
        setMsg("ä½ é‚„æ²’è¼¸å…¥å–”ï½", "warn");
        inp.focus();
        return;
      }

      attempted++;
      const ok = typed === current.norm;

      if (ok){
        correct++;
        score += 3;
        setMsg(`âœ… æ­£ç¢ºï¼+3 åˆ†ï¼ˆç­”æ¡ˆï¼š${current.en}ï¼‰`, "ok");
      } else {
        score = Math.max(0, score - 1);
        setMsg(`âŒ ä¸å°ï¼ˆåˆ†æ•¸ -1ï¼‰ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${current.en}`, "bad");
        markWrong(current);
      }

      locked = true;
      updateTop();
      lockCurrentUI();
    }

    function chooseMcq(selectedNorm, btnEl){
      if (!current || locked || mcqAnswered) return;

      attempted++;
      mcqAnswered = true;

      const ok = selectedNorm === current.norm;

      const buttons = Array.from($("#panel").querySelectorAll(".optionBtn"));
      for (const b of buttons) b.disabled = true;

      for (const b of buttons){
        const txt = b.textContent.split(". ").slice(1).join(". ");
        if (normalizeWord(txt) === current.norm) b.classList.add("correct");
      }

      if (ok){
        correct++;
        score += 1;
        btnEl.classList.add("correct");
        setMsg(`âœ… æ­£ç¢ºï¼+1 åˆ†ï¼ˆç­”æ¡ˆï¼š${current.en}ï¼‰`, "ok");
      } else {
        score = Math.max(0, score - 1);
        btnEl.classList.add("wrong");
        setMsg(`âŒ ä¸å°ï¼ˆåˆ†æ•¸ -1ï¼‰ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${current.en}`, "bad");
        markWrong(current);
      }

      locked = true;
      updateTop();
    }

    function saveSettings(){
      const s = {
        mode: $("#selMode").value,
        wrongOnly: $("#chkWrongOnly").checked,
        autoSpeak: $("#chkAutoSpeak").checked,
        showScramble: $("#chkShowScramble").checked,
        rate: parseFloat($("#rngRate").value || "1"),
        voiceName: $("#selVoice").value || voiceName,
        selectedParts: getSelectedParts()
      };
      saveJSON(storageSettingsKey, s);
    }

    function loadSettings(){
      const s = loadJSON(storageSettingsKey, null);
      if (!s) return;

      if (s.mode) $("#selMode").value = s.mode;
      $("#chkWrongOnly").checked = !!s.wrongOnly;
      $("#chkAutoSpeak").checked = !!s.autoSpeak;
      $("#chkShowScramble").checked = (s.showScramble !== false);
      if (typeof s.rate === "number") $("#rngRate").value = String(s.rate);
      if (s.voiceName) voiceName = s.voiceName;

      $("#rateText").textContent = `${parseFloat($("#rngRate").value).toFixed(2)}x`;
    }

    $("#btnStart").addEventListener("click", startGame);
    $("#btnResetSession").addEventListener("click", resetSession);

    $("#btnHint").addEventListener("click", hint);
    $("#btnReveal").addEventListener("click", reveal);
    $("#btnSkip").addEventListener("click", skip);
    $("#btnNext").addEventListener("click", next);

    $("#btnSpeak").addEventListener("click", () => { if (current) speak(current.en); });
    $("#btnSpeakSlow").addEventListener("click", () => { if (current) speak(current.en, 0.75); });

    $("#chkWrongOnly").addEventListener("change", () => { saveSettings(); });
    $("#selMode").addEventListener("change", () => { saveSettings(); });
    $("#chkAutoSpeak").addEventListener("change", () => { saveSettings(); });
    $("#chkShowScramble").addEventListener("change", () => { saveSettings(); if (current) renderPanel(); });
    $("#rngRate").addEventListener("input", () => {
      $("#rateText").textContent = `${parseFloat($("#rngRate").value).toFixed(2)}x`;
      saveSettings();
    });
    $("#selVoice").addEventListener("change", () => { voiceName = $("#selVoice").value; saveSettings(); });

    $("#btnSelectAll").addEventListener("click", () => {
      for (const p of PARTS){
        const cb = document.getElementById(`chk_${p.name}`);
        if (cb) cb.checked = true;
      }
      updateSelectedStats();
      saveSettings();
    });
    $("#btnSelectNone").addEventListener("click", () => {
      for (const p of PARTS){
        const cb = document.getElementById(`chk_${p.name}`);
        if (cb) cb.checked = false;
      }
      updateSelectedStats();
      saveSettings();
    });
    $("#btnInvert").addEventListener("click", () => {
      for (const p of PARTS){
        const cb = document.getElementById(`chk_${p.name}`);
        if (cb) cb.checked = !cb.checked;
      }
      updateSelectedStats();
      saveSettings();
    });

    $("#btnWrongClear").addEventListener("click", () => {
      if (confirm("ç¢ºå®šè¦æ¸…ç©ºéŒ¯é¡Œæœ¬ï¼Ÿ")) {
        clearWrongbook();
        setMsg("å·²æ¸…ç©ºéŒ¯é¡Œæœ¬ã€‚", "warn");
      }
    });
    $("#btnWrongExport").addEventListener("click", exportWrongbookCSV);

    document.addEventListener("keydown", (e) => {
      if (e.altKey && (e.key === "s" || e.key === "S")){
        e.preventDefault();
        if (current) speak(current.en);
        return;
      }
      if (qType !== "spelling") return;
      const inp = $("#spellInput");
      if (!inp) return;

      if (e.key === "Enter"){
        e.preventDefault();
        checkSpelling();
      } else if (e.key === "Escape"){
        e.preventDefault();
        if (!locked) { inp.value = ""; inp.focus(); setMsg("", ""); }
      }
    });

    function init(){
      loadSettings();
      renderWrongTable();
      updateTop();
      buildPartsUI();

      if (window.speechSynthesis){
        refreshVoices();
        window.speechSynthesis.onvoiceschanged = () => refreshVoices();
      } else {
        $("#selVoice").innerHTML = `<option value="">ï¼ˆæ­¤ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³ï¼‰</option>`;
      }

      $("#rateText").textContent = `${parseFloat($("#rngRate").value).toFixed(2)}x`;
    }

    init();
  </script>
</body>
</html>
